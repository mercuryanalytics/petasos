# Prerequirements
* Have your domain hosted in Amazon Route 53
* Have a SSL Certificate generated through Amazon Certificate Manager

# Preparing AWS for frontend

Since we're using a simple react app for frontend we can store it directly in a S3 bucket and have a Cloudfront distribution for pointing at it using SSL

* Login to your AWS account and go to S3
* Create two buckets with the following names: `www.domain.com` `domain.com`
    
We need to match the domain name to bucket name here since Cloudflare sends a HOST header which is used internally in AWS to map to the correct domain ------ TEST

We will use the `www.domain.com` as the main bucket for our project

* Go to `www.domain.com` bucket properties and select `Static Website Hosting`
* Fill in the `index document` with `index.html`
* Fill in the error document with `index.html`
* Fill in the redirection rule with the following value
```
<RoutingRules>
    <RoutingRule>
        <Condition>
            <HttpErrorCodeReturnedEquals>404</HttpErrorCodeReturnedEquals>
        </Condition>
        <Redirect>
            <HostName>www.domain.com</HostName>
            <Protocol>https</Protocol>
            <ReplaceKeyPrefixWith>#!/</ReplaceKeyPrefixWith>
        </Redirect>
    </RoutingRule>
    <RoutingRule>
        <Condition>
            <HttpErrorCodeReturnedEquals>403</HttpErrorCodeReturnedEquals>
        </Condition>
        <Redirect>
            <HostName>www.domain.com</HostName>
            <Protocol>https</Protocol>
            <ReplaceKeyPrefixWith>#!/</ReplaceKeyPrefixWith>
        </Redirect>
    </RoutingRule>
</RoutingRules>
```
* Hit the save button

* Go to Permissions tab
* Uncheck `Block public access here!`

Add the following rule in the Bucket Policy tab
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::frontend-container/*"
        }
    ]
}
```

To test this, you should upload sample index.html page and visit the endpoint listed in the `Static website hosting`

Let's move to our second bucket `domain.com`

This bucket will just be a redirect to our `www.domain.com` bucket

* Go to properties 
* Select `Static Webhosting`
* Check the `Redirect requests`
* Fill the `Target bucket or domain` with `www.domain.com`
* Fill the `Protocol` with `https` 


# Cloudfront setup

We will setup two distributions here, for each bucket.

Let's start with `www.domain.com` bucket

* Visit the Cloudfront and hit the `Create distribution` button
* Press the `Get started` button for the `Web` distribution
* Click the `Origin domain name` input and select your `www.domain.com` bucket
* Check the `Redirect HTTP to HTTPS` in the `Viewer protocol policy`
* In `Distribution Settings` select `Custom SSL Certificate` and select your issued Amazon Certificate Manager for your domain 
* Type `index.html` in the `Default Root Object`
* After creating the distribution go to Edit Distribution
* Change the s3 url from default bucket to `www.domain.com.s3-website.{region}.amazonaws.com` -  this is needed for the redirect rule set in the bucket to apply
Repeat the above steps for the `domain.com` bucket

# Domain setup
* Go to your `Hosted Zone` in Amazon Route 53
* Create an A record for `wwww.domain.com` and check the `Alias` checkbox
* Set the `Alias Target` to the domain name for the correct CDN - You will see this value when viewing your Cloudfront distributions, `Domain name` column
* Create an AAA record for the same domain, using the same steps as for the A record - this is for IPv6 domain

Repeat the above steps for `domain.com` bucket - note: leave the input blank empty


### This is for the moment with the Frontend setup, we will get back to that later

# Backend setup

* Setup your ec2 instance - I used a t2.micro
* Use the defaults until you arrive at the `Configure Security Group`
* The default will be only SSH access, we need to add `HTTP`, `HTTPS` and `Mysql/Aurora` security groups
* ssh into your instance using the private key generated by AWS
ssh into your instance
* Install some dependencies
```
sudo apt-get update && sudo apt-get -y upgrade
sudo apt install autoconf bison build-essential libssl-dev libyaml-dev libreadline6-dev zlib1g-dev libncurses5-dev libffi-dev libgdbm5 libgdbm-dev libmariadb-dev libmysqlclient-dev
```
* Install rbenv or rvm - I used rbenv here
```
git clone https://github.com/rbenv/rbenv.git ~/.rbenv
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(rbenv init -)"' >> ~/.bashrc
source ~/.bashrc
 git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build 
rbenv install 2.5.3
rbenv global 2.5.3
echo "gem: --no-document" > ~/.gemrc
```
* Install bundler
```
gem install bundler -v 2.1.4
``` 
* Install nginx
```
sudo apt-get update
sudo apt-get install -y nginx
sudo service nginx restart
```
* Install passenger
```
sudo apt-get install -y dirmngr gnupg
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7
sudo apt-get install -y apt-transport-https ca-certificates

sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger bionic main > /etc/apt/sources.list.d/passenger.list'
sudo apt-get update

sudo apt-get install -y libnginx-mod-http-passenger

if [ ! -f /etc/nginx/modules-enabled/50-mod-http-passenger.conf ]; then sudo ln -s /usr/share/nginx/modules-available/mod-http-passenger.load /etc/nginx/modules-enabled/50-mod-http-passenger.conf ; fi
sudo ls /etc/nginx/conf.d/mod-http-passenger.conf

sudo service nginx restart
```
* Setup a subdomain in Route 53 which points to the EC2 instance public IP
* Install certbot
```
sudo apt-get update
sudo apt-get install software-properties-common
sudo add-apt-repository universe
sudo add-apt-repository ppa:certbot/certbot
sudo apt-get update
sudo apt-get install certbot python3-certbot-nginx
```
* Create a config file in `/etc/nginx/sites-available/001-api.conf` with the following value
```
server {
     server_name api.domain.com;
 
     root /home/ubuntu/mercury-analytics-api/current/public;
 
     passenger_enabled on;
     passenger_ruby /home/ubuntu/.rbenv/versions/2.5.3/bin/ruby;
     rails_env production;
 }
```
* Generate certbot certificate with `sudo certbot --nginx` and follow the steps in there to setup SSL

Let's move to Auth0 setup now

# Auth0 setup
* Login to your Auth0 account
* Go to Applications
* Hit the `Create application` button
* Name your app and `Machine to Machine`
* On the next screen select `Auth0 Management API`
* Filter the scopes by `users` and press the `All` link
* Click the `Authorize` button and you should be set for your API

Now we'll create the frontend application
* Go to Applications
* Hit the `Create application` button
* Name your app, select `Single Page App` and hit the button.

Let's configure the Frontend application
* Go to applications
* Select your frontend application
* In `Allowed Callback URLs` and set your domains callbacks in there
For example, if your domain is frontend.domain.com, you should point this to `https://front.domain.com/auth/auth0/callback`
* In `Allowed Logout URLs` set your domain (eg: `https://frontend.domain.com`)
* Same values for `Allowed Web Origin` and `Allowed Origins (CORS)` as in Logout URLs

Let's add the rules now and the email template
* Go to rules
* Click the `Create Rule`
* Find the `Link Accounts with Same Email Address`, select it and hit the `Save changes` button
* Go to `Emails / Provider` and setup your Email server
* Go to `Emails / Templates`, select the `Change Password` template from the dropdown and paste the template found in AUTH-0-RULES.md

This should be all configs for Auth0!

For setting Google Social login you need to follow the steps here: https://auth0.com/docs/connections/social/google#1-set-up-your-app-in-google

# Deploying the frontend app
* Install AWS CLI
* Setup AWS CLI with your IAM user that has full access to S3Buckets and Cloudfront distribution (we need to invalidate the cache when deploying new changes)
* Open `src/auth_config.json` in frontend app 
    * Modify the `client_id` value with the one generated in your Auth0 frontend app
    * Modify the `domain` value with the one generated in your Auth0 frontend app
* Open `src/utils/constants.js`
    * Modify the `API_URL` from prod constant with your API url
    * Modify the `APP_URL` with your frontend url
* Run the `BUCKET_NAME=www.example.com DISTRIBUTION_ID=YOUR_DISTRIBUTION_ID npm run-script s3deploy`

After this is done it should be up & running

# Deploying the backend app
* Go to root project
* Run `EDITOR=vim bundle exec rails credentials:edit`
    * app_host: YOUR_BASE_URL - this is needed when generating the asset host for logo 
    * auth0: (note: For Auth0 you'll need to open your Machine to Machine application from Applications and go to Settings tab)
        * iss: DOMAIN VALUE
        * audience: DOMAIN VALUE
        * management_api:
            * base_url: {DOMAIN_VALUE}/
            * client_id: CLIENT ID VALUE
            * client_secret: CLIENT SECRET VALUE
            * audience: {DOMAIN VALUE}/api/v2
    * aws:
        * access_key_id: IAM Access key 
        * secret_access_key: IAM Secret
        * region: bucket region
        * bucket: bucket name
    database:
        RDS_DB_NAME: mercury_analytics_api_production
        RDS_USERNAME: RDS name
        RDS_PASSWORD: RDS password
        RDS_HOSTNAME: RDS hostname
        RDS_PORT: RDS PORT
* Open `config/environments/production`
    * add `config.hosts << YOUR_HOSTNAME`


* Go to mercury-analytics-api project root and open `config/deploy/production.rb`
    * Set your IP and SSH key location for connecting to ec2 instance
* Open `config/deploy.rb` and make changes if you have other settings than the default ones
Notes: 
  * don't forget to add your SSH key for deploy user in github!
  * You'll need to manually create the database if it does not exist, since capistrano will not do this
Run `cap production deploy` and it should deploy the app based on your settings
Ssh into your machine to create a super user using the following rake task
`RAILS_ENV=production bundle exec rails users:create_admin_user\['your-email','MyPassword123'\]`



